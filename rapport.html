<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Rapport Amélioré</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link rel="stylesheet" href="style-top.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
      rel="stylesheet"
    />
    
    <style>
      body {
        background-color: #f8f9fa;
      }
      .form-section {
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
      }
      .form-section.required {
        border-left: 5px solid #dc3545;
      }
      .form-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #0d6efd;
        margin-bottom: 10px;
        position: relative;
      }
      .form-title.required::after {
        content: " (obligatoire)";
        color: #dc3545;
        font-size: 1rem;
        font-weight: normal;
        position: absolute;
        margin-left: 5px;
      }
      .input-group {
        margin-bottom: 15px;
      }
      .input-group-text {
        width: 150px;
        background-color: #0d6efd;
        color: white;
        font-weight: bold;
      }
      .btn {
        font-size: 1rem;
        padding: 10px 20px;
      }
      .btn-type-rapport {
        height: 50px;
        width: 100%;
      }
      @media (min-width: 768px) {
        .btn-type-rapport {
          font-size: 1.25rem;
        }
      }
      .radio-group {
        display: flex;
        align-items: center;
        gap: 0;
        flex-grow: 1;
      }
      .radio-group label {
        background-color: #f8f9fa;
        border: 1px solid #0d6efd;
        border-radius: 0;
        padding: 5px 15px;
        color: #0d6efd;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
        flex: 1;
        text-align: center;
      }
      .radio-group label:first-child {
        border-top-left-radius: 4px;
        border-bottom-left-radius: 4px;
      }
      .radio-group label:last-child {
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
      }
      .radio-group input[type="radio"] {
        display: none;
      }
      .radio-group input[type="radio"]:checked + label {
        background-color: #0d6efd;
        color: white;
      }
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 1050;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #0d6efd;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <header class="mb-4 text-center">
        <img
          src="logo techmine.svg"
          alt="Logo"
          class="mb-3"
          style="max-height: 80px"
        />
        <h1 class="text-primary">Rapport</h1> <button class="btn btn-outline-primary" onclick="window.location.href='rapportOld.html'">Ancienne version du rapport</button>
        
      </header>

      <div class="loading-overlay" id="loading-overlay">
        <div>Chargement...</div>
      </div>

      <form id="rapportForm">
      <section class="form-section required">
        <h2 class="form-title required">Informations Générales</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-user"></i> Client</span
              >
              <input
                type="text"
                class="form-control"
                id="client"
                list="clients"
                placeholder="Nom du client"
                required
              />
              <datalist id="clients"></datalist>
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-industry"></i> Carrière</span
              >
              <input
                type="text"
                class="form-control"
                id="Carriere"
                list="carrieres"
                placeholder="Nom de la carrière"
                required
              />
              <datalist id="carrieres"></datalist>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-calendar-alt"></i> Date</span
              >
              <input
                type="text"
                class="form-control"
                id="date"
                placeholder=""
                required
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-clock"></i> Heures Travail</span
              >
              <input
                type="text"
                class="form-control"
                id="NbHTravail"
                placeholder="Nombre d'heures"
                required
              />
            </div>
          </div>
        </div>
      </section>

      <section class="form-section required">
        <h2 class="form-title required">Détails de la Production</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-ruler"></i> Mètres Forés</span
              >
              <input
                type="text"
                class="form-control"
                id="NbMF"
                placeholder="Nombre de mètres"
                required
              />
            </div>
          </div>

          <div class="col">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-comment"></i> Commentaire</span
              >
              <input
                type="text"
                class="form-control"
                id="CommMF"
                placeholder="Ajoutez un commentaire"
                required
              />
            </div>
          </div>
        </div>
      </section>

      <section class="form-section">
        <h2 class="form-title">Informations supplémentaire</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-road"></i> Temps de Route</span
              >
              <input
                type="text"
                class="form-control"
                id="TDR"
                placeholder="Temps de route"
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-hotel"></i>
                Gd ou Panier
              </span>
              <div class="radio-group">
                <input type="radio" id="Gd" name="GdPanier" />
                <label for="Gd">Gd</label>
                <input type="radio" id="Panier" name="GdPanier" />
                <label for="Panier">Panier</label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="form-section required">
        <h2 class="form-title required">Informations Foreuse</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-truck"></i> Numéro Foreuse
              </span>
              <input
                type="text"
                class="form-control"
                id="numF"
                list="machines"
                placeholder="Numéro de la foreuse"
                required
              />
              <datalist id="machines"></datalist>
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-stopwatch"></i> Heures Marteau
              </span>
              <input
                type="text"
                class="form-control"
                id="NbHM"
                placeholder="Nombre d'heures"
                required
              />
            </div>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-clock"></i> Heure Début
              </span>
              <input
                type="text"
                class="form-control"
                id="NbHD"
                placeholder="Compteur début"
                required
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-clock"></i> Heure Fin
              </span>
              <input
                type="text"
                class="form-control"
                id="NbHF"
                placeholder="Compteur fin"
                required
              />
            </div>
          </div>
        </div>
      </section>

      <section class="form-section">
        <h2 class="form-title">Informations Voiture</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-car"></i> Numéro Voiture</span
              >
              <input
                type="text"
                class="form-control"
                id="voiture"
                list="voitures"
                placeholder="Numéro de la voiture"
              />
              <datalist id="voitures"></datalist>
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-tachometer-alt"></i> Kilométrage</span
              >
              <input
                type="text"
                class="form-control"
                id="kilV"
                placeholder="Kilométrage"
              />
            </div>
          </div>
        </div>
      </section>

      <section class="form-section required">
        <h2 class="form-title required">Informations Arrêt</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-stop-circle"></i> Heures d'Arrêt</span
              >
              <input
                type="text"
                class="form-control"
                id="NbHA"
                placeholder="Nombre d'heures d'arrêt"
                required
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-comment"></i> Commentaire</span
              >
              <input
                type="text"
                class="form-control"
                id="CommA"
                placeholder="Ajoutez un commentaire"
                required
              />
            </div>
          </div>
        </div>
      </section>

      <section class="form-section required">
        <h2 class="form-title required">Informations Panne</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-tools"></i> Heures de Panne</span
              >
              <input
                type="text"
                class="form-control"
                id="NbHP"
                placeholder="Nombre d'heures de panne"
                required
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-comment"></i> Commentaire</span
              >
              <input
                type="text"
                class="form-control"
                id="CommP"
                placeholder="Ajoutez un commentaire"
                required
              />
            </div>
          </div>
        </div>
      </section>

      <section class="form-section required">
        <h2 class="form-title required">Informations Perte</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-exclamation-triangle"></i> Perte Barre</span
              >
              <input
                type="number"
                class="form-control"
                id="nbPB"
                placeholder="Nombre de barres perdues"
                required
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-exclamation-triangle"></i> Perte
                Taillant</span
              >
              <input
                type="number"
                class="form-control"
                id="nbPT"
                placeholder="Nombre de taillants perdus"
                required
              />
            </div>
          </div>
        </div>
      </section>

  

      <section class="form-section">
        <h2 class="form-title">Informations Transfert</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-truck-moving"></i> Transporteur</span
              >
              <input
                type="text"
                class="form-control"
                id="CT"
                placeholder="Nom du transporteur"
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-hourglass-half"></i> Durée</span
              >
              <input
                type="text"
                class="form-control"
                id="DT"
                placeholder="Durée du transfert"
              />
            </div>
          </div>
        </div>
      </section>

      <section class="form-section">
        <h2 class="form-title">Informations GNR</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-gas-pump"></i> Fournisseur</span
              >
              <input
                type="text"
                class="form-control"
                id="CG"
                placeholder="Nom du fournisseur"
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-balance-scale"></i> Quantité</span
              >
              <input
                type="text"
                class="form-control"
                id="QG"
                placeholder="Quantité en litres"
              />
            </div>
          </div>
        </div>
      </section>

      <div class="text-end">
        <button type="submit" class="btn btn-outline-primary" id="submit">
          soumettre
        </button>
        <!-- <button type="button" class="btn btn-outline-secondary" id="second">
          Creer un deuxieme rapport
        </button> -->
      </div>
    </form>
    </div>

    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      $(document).ready(function () {
        $("#date").daterangepicker({
          singleDatePicker: true,
          locale: {
            format: " YYYY-MM-DD ",
            separator: " au ",
            applyLabel: "Appliquer",
            cancelLabel: "Annuler",
            fromLabel: "Du",
            toLabel: "À",
            customRangeLabel: "Personnalisé",
            weekLabel: "S",
            daysOfWeek: ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"],
            monthNames: [
              "Janvier",
              "Février",
              "Mars",
              "Avril",
              "Mai",
              "Juin",
              "Juillet",
              "Août",
              "Septembre",
              "Octobre",
              "Novembre",
              "Décembre",
            ],
            firstDay: 1,
          },
          opens: "right",
        });
      });
    </script>
    <script type="module">
      let UserCreds = JSON.parse(sessionStorage.getItem("UserCreds"));
      let UserInfo = JSON.parse(sessionStorage.getItem("UserInfo"));

      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA5KivS1hhrIufEYwt8T8MN1hguKa3aSMY",
        authDomain: "test-techmine.firebaseapp.com",
        databaseURL:
          "https://test-techmine-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "test-techmine",
        storageBucket: "test-techmine.appspot.com",
        messagingSenderId: "876142620682",
        appId: "1:876142620682:web:5bad29bd4f71d82be6aff3",
        measurementId: "G-2LKJFXNQ58",
      };

      const app = initializeApp(firebaseConfig);

      import {
        getDatabase,
        ref,
        child,
        get,
        set,
        update,
        remove,
        onValue,
        query,
        orderByChild,
        equalTo,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

      const db = getDatabase();
      const auth = getAuth();

      let user = sessionStorage.getItem("user-uid");
      let dateNb = Date.now();
      let selectedClientId = null;
      let isSimple = null;
      let clientsData = {};
      let carrieresData = {};
      let machinesData = {};

      //vérfication de la version de l'application
      const versionRef = ref(db, "appInfo/version");
      onValue(versionRef, (snapshot) => {
        const latestVersion = snapshot.val();
        const currentVersion = localStorage.getItem("appVersion");
        if (currentVersion != latestVersion) {
          localStorage.setItem("appVersion", latestVersion);
          window.location.reload();
        }
      });

      // vérification de l'authentification de l'utilisateur
      function checkUserAuthentication() {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log(user);
          } else {
            console.log("pas d'utilisateur");
            window.location.href = "index.html";
          }
          if (sessionStorage.getItem("user-uid") == null) {
            window.location.href = "index.html";
          }
        });
      }

      // récupération des clients
      function fetchClients() {
        const clientDataList = document.getElementById("clients");
        const clientsRef = ref(db, "clients");

        onValue(
          clientsRef,
          (usersSnapshot) => {
            const clients = usersSnapshot.val() || {};

            clientDataList.innerHTML = "";

            const sortedClientIds = Object.keys(clients).sort((a, b) =>
              clients[a].name.localeCompare(clients[b].name)
            );

            for (const clientId of sortedClientIds) {
              const clientName = clients[clientId].name;
              const option = document.createElement("option");
              option.value = clientName;
              option.dataset.clientId = clientId;
              clientDataList.appendChild(option);
            }
          },
          (error) => {
            console.error("Error fetching clients:", error);
          }
        );
      }

      // enregistrement des données du rapport
      function AddData() {
        const client = document.getElementById("client");
        const Carriere = document.getElementById("Carriere");
        const date = document.getElementById("date").value;
        const NbHTravail = document.getElementById("NbHTravail");
        const NbMF = document.getElementById("NbMF");
        const TDR = document.getElementById("TDR");
        const GdP = document.getElementById("Gd").checked ? "Gd" : "Panier";
        const numF = document.getElementById("numF");
        const NbHD = document.getElementById("NbHD");
        const NbHF = document.getElementById("NbHF");
        const NbHM = document.getElementById("NbHM");
        const NbHA = document.getElementById("NbHA");
        const CommA = document.getElementById("CommA");
        const NbHP = document.getElementById("NbHP");
        const CommP = document.getElementById("CommP");
        const CommMF = document.getElementById("CommMF");
        const CT = document.getElementById("CT");
        const DT = document.getElementById("DT");
        const CG = document.getElementById("CG");
        const QG = document.getElementById("QG");
        const kilV = document.getElementById("kilV");
        const voiture = document.getElementById("voiture").value;


        set(ref(db, "rapport/" + dateNb), {
          infos: {
            client: client.value,
            Carriere: Carriere.value,
            date: date,
            NbHTravail: NbHTravail.value,
            NbMF: NbMF.value,
            TDR: TDR.value,
            GdP: GdP,
            numF: numF.value,
            NbHD: NbHD.value,
            NbHF: NbHF.value,
            NbHM: NbHM.value,
            NbHA: NbHA.value,
            CommA: CommA.value,
            NbHP: NbHP.value,
            CommP: CommP.value,
            CommMF: CommMF.value,
            CT: CT.value,
            DT: DT.value,
            CG: CG.value,
            QG: QG.value,
            kilV: kilV,
            voiture: voiture,
          },
          date: date,
          dateTimestamp: new Date().getTime(),
          user: user,
        })
          .then(() => {
            setTimeout(() => {
              document.getElementById("loading-overlay").style.add = "D-flex";
              window.location.href = "Impression-rapport.html?id=" + dateNb;
            }, 3000);
            showMessage("Données sauvegardées avec succès !", "success");
          })
          .catch((error) => {
            showMessage(
              "Erreur lors de la sauvegarde des données : " + error.message,
              "danger"
            );
          });
      }

      // affichage des messages
      function showMessage(message, type) {
        const messageContainer = document.getElementById("alert-container");
        messageContainer.style.display = "block";
        messageContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                  ${message}
                                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>`;
        setTimeout(() => {
          const alert = bootstrap.Alert.getInstance(
            document.querySelector(".alert")
          );
          messageContainer.style.display = "none";
          alert.close();
        }, 5000);

        setTimeout(() => {
          location.reload();
        }, 5000);
      }

      // vérification de l'authentification de l'utilisateur
      function checkUserRole(userId) {
        const userRef = ref(db, `users/${userId}`);
        return get(userRef).then((snapshot) => {
          const userData = snapshot.val();
          console.log("Données utilisateur :", userData.role);
          return (
            userData.role === "cadre" ||
            userData.role === "responsable exploitation" ||
            userData.role === "directeur" ||
            userData.role === "responsable agence"
          );
        });
      }

      // Gestion de l'état d'authentification
      auth.onAuthStateChanged((user) => {
        if (user) {
          checkUserRole(user.uid)
            .then((isCadre) => {
              const adminMenuItems =
                document.querySelectorAll(".menu-item-admin");
              adminMenuItems.forEach((item) => {
                item.style.display = isCadre ? "block" : "none";
              });
            })
            .catch((error) => {
              console.error("Erreur lors de la vérification du rôle :", error);
              const adminMenuItems =
                document.querySelectorAll(".menu-item-admin");
              adminMenuItems.forEach((item) => {
                item.style.display = "none";
              });
            });
        } else {
          const adminMenuItems = document.querySelectorAll(".menu-item-admin");
          adminMenuItems.forEach((item) => {
            item.style.display = "none";
          });
        }
      });

      // récupération des données des clients et des carrières
      function fetchClientsAndCarrieres() {
        const clientsRef = ref(db, "clients");
        const carrieresRef = ref(db, "chantiers");
        const machinesRef = ref(db, "machine");

        get(clientsRef).then((clientsSnapshot) => {
          clientsData = clientsSnapshot.val() || {};
          populateClientsDataList();
        });

        get(carrieresRef).then((carrieresSnapshot) => {
          carrieresData = carrieresSnapshot.val() || {};
          populateCarrieresDataList();
        });
        get(machinesRef).then((machinesSnapshot) => {
          machinesData = machinesSnapshot.val() || {};
          populateMachineDataList();
        });
      }

      //affichage des données des clients
      function populateClientsDataList() {
        const clientDataList = document.getElementById("clients");
        clientDataList.innerHTML = "";

        const sortedClientIds = Object.keys(clientsData).sort((a, b) =>
          clientsData[a].name.localeCompare(clientsData[b].name)
        );

        for (const clientId of sortedClientIds) {
          const clientName = clientsData[clientId].name;
          const option = document.createElement("option");
          option.value = clientName;
          option.dataset.clientId = clientId;
          clientDataList.appendChild(option);
        }
      }

      //affichage des données des machines
      function populateMachineDataList() {
        const machineDataList = document.getElementById("machines");
        const voitureDataList = document.getElementById("voitures");
        machineDataList.innerHTML = "";
        voitureDataList.innerHTML = "";

        const sortedMachinesIds = Object.keys(machinesData).sort((a, b) =>
          machinesData[a].Nmatériel.localeCompare(machinesData[b].Nmatériel)
        );

        for (const machineId of sortedMachinesIds) {
          if (
            machinesData[machineId].Nmatériel.startsWith("15") ||
            machinesData[machineId].Nmatériel.startsWith("TMF") ||
            machinesData[machineId].Nmatériel.startsWith("F")
          ) {
            const machineName = machinesData[machineId].Nmatériel;
            const option = document.createElement("option");
            option.value = machineName;
            option.dataset.machineId = machineId;
            machineDataList.appendChild(option);
          } else {
            const machineName = machinesData[machineId].Nmatériel;
            const option = document.createElement("option");
            option.value = machineName;
            option.dataset.machineId = machineId;
            voitureDataList.appendChild(option);
          }
        }
      }

      //affichage des données des carrières
      function populateCarrieresDataList() {
        const carriereDataList = document.getElementById("carrieres");
        carriereDataList.innerHTML = "";

        const sortedCarriereIds = Object.keys(carrieresData).sort((a, b) =>
          carrieresData[a].name.localeCompare(carrieresData[b].name)
        );

        for (const carriereId of sortedCarriereIds) {
          const carriereName = carrieresData[carriereId].name;
          const option = document.createElement("option");
          option.value = carriereName;
          option.dataset.carriereId = carriereId;
          carriereDataList.appendChild(option);
        }
      }

      // fonction qui récupere le client selectionné et filtre les carrières par client
      document.getElementById("client").addEventListener("input", () => {
        const selectedClientName = document.getElementById("client").value;
        const selectedClient = Object.values(clientsData).find(
          (client) => client.name === selectedClientName
        );

        if (selectedClient) {
          selectedClientId = selectedClient.id;
          filterCarrieresByClient(selectedClientId);
        }
      });
      document.getElementById("numF").addEventListener("input", () => {
        const selectedMachineName = document.getElementById("numF").value;
        const selectedMachine = Object.values(machinesData).find(
          (machine) => machine.name === selectedMachineName
        );

        if (selectedMachine) {
          populateMachineDataList();
        }
      });

      // fonction qui filtre les carrières par client
      function filterCarrieresByClient(clientId) {
        const carriereDataList = document.getElementById("carrieres");
        carriereDataList.innerHTML = "";

        const filteredCarrieres = Object.values(carrieresData).filter(
          (carriere) => carriere.clientId === clientId
        );

        const sortedCarriereIds = filteredCarrieres.sort((a, b) =>
          a.name.localeCompare(b.name)
        );

        for (const carriere of sortedCarriereIds) {
          const option = document.createElement("option");
          option.value = carriere.name;
          option.dataset.carriereId = carriere.id;
          carriereDataList.appendChild(option);
        }
      }
      // fonction qui verifie si le nom de la carriere existe et met une croix rouge si il n'existe pas et une coche verte si il existe
      function checkCarriereName() {
        const selectedCarriereName = document.getElementById("Carriere").value;
        const selectedCarriere = Object.values(carrieresData).find(
          (carriere) => carriere.name === selectedCarriereName
        );

        if (selectedCarriere) {
          document.getElementById("Carriere").classList.remove("is-invalid");
          document.getElementById("Carriere").classList.add("is-valid");
        } else {
          document.getElementById("Carriere").classList.remove("is-valid");
          document.getElementById("Carriere").classList.add("is-invalid");
        }
      }
      // fonction qui verifie si le nom de la machine existe et met une croix rouge si il n'existe pas et une coche verte si il existe
      function checkMachineName() {
        const selectedMachineName = document.getElementById("numF").value;
        const selectedMachine = Object.values(machinesData).find(
          (machine) => machine.name === selectedMachineName
        );

        if (selectedMachine) {
          document.getElementById("numF").classList.remove("is-invalid");
          document.getElementById("numF").classList.add("is-valid");
        } else {
          document.getElementById("numF").classList.remove("is-valid");
          document.getElementById("numF").classList.add("is-invalid");
        }
      }
      // fonction qui verifie si le nom de la voiture existe et met une croix rouge si il n'existe pas et une coche verte si il existe
      function checkVoitureName() {
        const selectedVoitureName = document.getElementById("voiture").value;
        const selectedVoiture = Object.values(machinesData).find(
          (machine) => machine.name === selectedVoitureName
        );

        if (selectedVoiture) {
          document.getElementById("voiture").classList.remove("is-invalid");
          document.getElementById("voiture").classList.add("is-valid");
        } else {
          document.getElementById("voiture").classList.remove("is-valid");
          document.getElementById("voiture").classList.add("is-invalid");
        }
      }
      // fonction qui verifie si le nom du client existe et met une croix rouge si il n'existe pas et une coche verte si il existe
      function checkClientName() {
        const selectedClientName = document.getElementById("client").value;
        const selectedClient = Object.values(clientsData).find(
          (client) => client.name === selectedClientName
        );

        if (selectedClient) {
          document.getElementById("client").classList.remove("is-invalid");
          document.getElementById("client").classList.add("is-valid");
        } else {
          document.getElementById("client").classList.remove("is-valid");
          document.getElementById("client").classList.add("is-invalid");
        }
      }

      // fonction qui récupere le nom de la carriere selectionnée et affiche le nom du client
      document.getElementById("Carriere").addEventListener("input", () => {
        const selectedCarriereName = document.getElementById("Carriere").value;
        const selectedCarriere = Object.values(carrieresData).find(
          (carriere) => carriere.name === selectedCarriereName
        );

        if (selectedCarriere) {
          checkCarriereName();
          const clientName = clientsData[selectedCarriere.clientId].name;
          document.getElementById("client").value = clientName;
        }
      });

      // submit du formulaire, appel de AddData()
      document.getElementById("rapportForm").addEventListener("submit", (e) => {
        e.preventDefault();
        AddData();
      });


      window.onload = function () {
        fetchClients();
        fetchClientsAndCarrieres();
        checkUserAuthentication();
      };
    </script>

  </body>
</html>
