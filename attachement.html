<!DOCTYPE html>
<html lang="fr">
  <head>
    <title>Attachement</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="style-top.css" />
    <style>
      #datesForage::placeholder,
      #QuantiteForage::placeholder,
      #UniteForage::placeholder,
      #datesMinage::placeholder,
      #QuantiteMinage::placeholder,
      #UniteMinage::placeholder {
        color: #0d6efd;
      }
      .is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
      }
    </style>
  </head>

  <body style="height: 150vh">
    <div id="message" class="alert d-none"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch("header.html")
          .then((response) => response.text())
          .then((data) => {
            document.body.insertAdjacentHTML("afterbegin", data);
    
            const pageTitle = "Attachement"; // Titre de la page
            // Gestion du menu burger
            const burger = document.querySelector(".burger");
            const nav = document.querySelector(".nav-links");
            if (burger && nav) {
              burger.addEventListener("click", () => {
                nav.classList.toggle("nav-active");
              });
            }
            const divHeader = document.getElementById("div-header");
            divHeader.classList.add("bg-white");
            // Mise à jour dynamique du titre
            if (typeof pageTitle !== 'undefined') {
              const titleElement = document.getElementById('page-title');
              //on vide le titre
              if (titleElement) {
                titleElement.textContent = pageTitle; // Utiliser le titre défini pour la page
              }
            }
          });
      });
    </script>
    <div id="message" class="alert d-none"></div>
    <!-- bloc du bas -->
    <div class="container-fluid bg-primary custom-height-bot">
      <div class="row">
        <div class="col col-1"></div>
        <div class="col col-10 text-center">
          <div class="mt-3">
            <button
              type="button"
              class="btn btn-light BtnStep"
              id="BtnStep"
              onclick="showTab(0)"
            >
              Chantier
            </button>
            <button
              type="button"
              class="btn btn-light BtnStep"
              id="BtnStep"
              onclick="showTab(1)"
            >
              Forage
            </button>
            <button
              type="button"
              class="btn btn-light BtnStep"
              id="BtnStep"
              onclick="showTab(2)"
            >
              Minage
            </button>
            <button
              type="button"
              class="btn btn-light BtnStep"
              id="BtnStep"
              onclick="showTab(3)"
            >
              Autre
            </button>
            <button
              type="button"
              class="btn btn-light BtnStep step-att"
              id="BtnStep"
              onclick="showTab(4)"
            >
              gnr
            </button>
            <button
              type="button"
              class="btn btn-light BtnStep step-att"
              id="BtnStep"
              onclick="showTab(5)"
            >
              Pièces Jointes
            </button>
            <button type="button" class="btn btn-secondary BtnStep" id="submit">
              Valider
            </button>
          </div>
        </div>
        <div class="col col-1"></div>
      </div>
      <div class="row text-center mt-3">
        <div class="alert-container" id="alert-container"></div>
        <!-- form chantier-->
        <div class="col col-12 text-center">
          <div
            class="container-fluid bg-white p-3 rounded-4 form-container align-items-center align-self-center tab custom-height-tab"
          >
            <table class="table table-bordered border-primary">
              <tr>
                <td
                  class="fw-bold custom-font-sub-title text-primary"
                  style="width: 33%"
                >
                  CLIENT
                </td>
                <td
                  class="fw-bold custom-font-sub-title text-primary"
                  style="width: 33%"
                >
                  CARRIERE / CHANTIER
                </td>
                <td
                  class="fw-bold custom-font-sub-title text-primary"
                  style="width: 33%"
                >
                  OBSERVATION
                </td>
              </tr>
              <tr style="height: 10vh">
                <td>
                  <input
                    type="text"
                    class="border border-white input-table"
                    id="client"
                    list="clients"
                  />
                  <datalist id="clients"> </datalist>
                </td>
                <td>
                  <input
                    type="text"
                    class="border border-white input-table"
                    id="chantier"
                    list="chantiers"
                  />
                  <datalist id="chantiers">
                    <!-- Options will be dynamically added here -->
                  </datalist>
                </td>
                <td>
                  Perte outillage dans tir :
                  <form>
                    <div
                      class="btn-group"
                      role="group"
                      aria-label="Basic radio toggle button group"
                      id="perte_outillage_tir"
                    >
                      <input
                        type="radio"
                        class="btn-check"
                        name="radio-perte"
                        id="oui_perte"
                        value="true"
                        autocomplete="off"
                        required
                      />
                      <label class="btn btn-outline-primary" for="oui_perte"
                        >OUI</label
                      >
                      <input
                        type="radio"
                        class="btn-check"
                        name="radio-perte"
                        id="non_perte"
                        value="false"
                        autocomplete="off"
                        checked
                      />
                      <label class="btn btn-outline-primary" for="non_perte"
                        >NON</label
                      >
                    </div>
                  </form>

                  <input
                    type="text"
                    class="border border-white input-table"
                    id="obsevation"
                  />
                </td>
              </tr>
            </table>
            <button
              type="button"
              id="valider"
              class="btn btn-white border-primary text-primary fw-bold border-3 custom-height-btn"
              onclick="validStep(0)"
            >
              valider
            </button>
          </div>

          <!-- form forage-->
          <div class="col col-12 text-center">
            <div
              class="container-fluid bg-white p-3 rounded-4 form-container align-items-center align-self-center tab custom-height-tab text-primary"
            >
              <table
                class="table table-bordered border-primary"
                style="height: 25vh"
              >
                <tr>
                  <td>
                    <div class="mb-3">
                      <label for="daterange" class="form-label"></label>
                      <input
                        type="text"
                        class="form-control border border-white border border-white input-table-1"
                        id="datesForage"
                        placeholder="Cliquez pour choisir une date"
                      />
                    </div>
                  </td>
                </tr>
                <tr style="height: 10vh">
                  <td style="width: 100vh">
                    <h3 class="custom-font-sub-title mx-1">
                      désignation des travaux
                    </h3>
                    <table
                      class="table-bordered border-primary w-100"
                      style="height: 30vh"
                    >
                      <tr>
                        <td>
                          <div class="form-check">
                            <input
                              class="form-check-input border border-primary mx-1"
                              type="checkbox"
                              value="oui"
                              id="forage"
                            />
                            <label
                              class="form-check-label text-primary fw-bold me-5"
                              for="flexCheckDefault"
                            >
                              Forage
                            </label>
                          </div>
                        </td>
                        <td>
                          <input
                            type="text"
                            placeholder="HMF* début"
                            class="text-primary border border-white input-table-2"
                            id="HMFDebut"
                          />
                        </td>
                      </tr>
                      <tr>
                        <td>
                          <input
                            type="text"
                            placeholder="N° du plan de forage"
                            class="text-primary border border-white input-table-2"
                            id="NPlanForage"
                          />
                        </td>
                        <td>
                          <input
                            type="text"
                            placeholder="HMF* fin"
                            class="text-primary border border-white input-table-2"
                            id="HMFFin"
                          />
                        </td>
                      </tr>
                      <tr>
                        <td>
                          <input
                            type="text"
                            placeholder="Transfert (1 ou 0)"
                            class="text-primary border border-white input-table-2"
                            id="Transfert"
                          />
                        </td>
                        <td>
                          <table style="width: 100%">
                            <tr>
                              <td
                                class="border border-primary border-top-0 border-start-0 border-bottom-0"
                              >
                                <input
                                  type="text"
                                  placeholder="H de panne"
                                  class="text-primary border border-white input-table-2"
                                  id="HeuresPanne"
                                />
                              </td>
                              <td>
                                <input
                                  type="text"
                                  placeholder="commentaire"
                                  class="text-primary border border-white input-table-2"
                                  id="CommP"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td
                                class="border border-primary border-top-0 border-bottom-0 border-start-0"
                              >
                                <input
                                  type="text"
                                  placeholder="H d'arrêt"
                                  class="text-primary border border-white input-table-2"
                                  id="HeuresArret"
                                />
                              </td>
                              <td>
                                <input
                                  type="text"
                                  placeholder="commentaire"
                                  class="text-primary border border-white input-table-2"
                                  id="CommA"
                                />
                              </td>
                            </tr>
                          </table>
                        </td>
                      </tr>
                    </table>
                    <br />
                  </td>
                </tr>
                <tr>
                  <table
                    class="table table-bordered border-primary"
                    style="width: 100%"
                  >
                    <tbody id="tableBody">
                      <tr>
                        <td>
                          <input
                            type="text"
                            class="border-primary input-table-2"
                            id="DiametreForage"
                            placeholder="Diamètre de forage"
                            style="border-style: none none solid none"
                          />
                        </td>
                        <td>
                          <input
                            type="text"
                            class="border-primary input-table-2"
                            id="QuantiteForage"
                            placeholder="Quantité"
                            style="border-style: none none solid none"
                          />
                        </td>
                        <td>
                          <input
                            type="text"
                            class="border-primary input-table-2"
                            id="UniteForage"
                            placeholder="Unité"
                            style="border-style: none none solid none"
                          />
                        </td>
                      </tr>
                    </tbody>
                  </table>
                  <input
                    type="button"
                    class="btn btn-primary mt-2"
                    value="Ajouter une ligne"
                    onclick="addRow()"
                  />
                </tr>
              </table>
              <button
                type="button"
                id="valider"
                class="btn btn-white border-primary text-primary fw-bold border-3 custom-height-btn"
                onclick="validStep(1)"
              >
                valider
              </button>
              <p class="mt-2">*HMF = heure Moteur Foreuse</p>
            </div>

            <!-- form minage-->
            <div class="col col-12 text-center">
              <div
                class="container-fluid bg-white p-3 rounded-4 form-container align-items-center align-self-center tab custom-height-tab text-primary"
              >
                <table class="table table-bordered border-primary">
                  <tr>
                    <td>
                      <div class="mb-3">
                        <label
                          for="daterange2"
                          class="form-label fw-bold"
                        ></label>
                        <input
                          type="text"
                          class="form-control border border-white border border-white input-table-1"
                          id="datesMinage"
                          placeholder="Cliquez pour choisir une date"
                        />
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td style="width: 100vh">
                      <h3 class="custom-font-sub-title mx-1">
                        désignation des travaux
                      </h3>
                      <table
                        class="table table-bordered border-primary"
                        style="height: 30vh"
                      >
                        <tr>
                          <td>
                            <div class="form-check mb-3">
                              <input
                                class="form-check-input border border-primary mx-1"
                                type="checkbox"
                                value=""
                                id="minage"
                              />
                              <label
                                class="form-check-label text-primary fw-bold me-5"
                                for="flexCheckDefault"
                              >
                                Minage
                              </label>
                            </div>
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <input
                              type="text"
                              placeholder=" N° du plan de tir"
                              class="text-primary border border-white input-table-2"
                              id="NPlanTir"
                            />
                          </td>
                        </tr>
                        <tr>
                          <td class="text-primary">
                            implantation
                            <div
                              class="btn-group"
                              role="group"
                              aria-label="Basic radio toggle button group"
                              id="Implantation"
                            >
                              <input
                                type="radio"
                                class="btn-check"
                                name="laser2D"
                                id="laser2D"
                                autocomplete="off"
                              />
                              <label
                                class="btn btn-outline-primary"
                                for="laser2D"
                                >Laser 2D</label
                              >

                              <input
                                type="radio"
                                class="btn-check"
                                name="GPS"
                                id="GPS"
                                autocomplete="off"
                              />
                              <label class="btn btn-outline-primary" for="GPS"
                                >GPS</label
                              >

                              <input
                                type="radio"
                                class="btn-check"
                                name="Autres"
                                id="Autres"
                                autocomplete="off"
                              />
                              <label
                                class="btn btn-outline-primary"
                                for="btnradio3"
                                >Autres</label
                              >
                            </div>
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <input
                              type="text"
                              placeholder="Nombre de sismographes posés"
                              class="text-primary border border-white input-table-2"
                              id="NbSismographes"
                            />
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <input
                        type="text"
                        class="border border-white border border-white input-table-1"
                        id="QuantiteMinage"
                        placeholder="Quantité"
                      />
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <input
                        type="text"
                        class="border border-white border border-white input-table-1"
                        id="UniteMinage"
                        placeholder="Unité"
                      />
                    </td>
                  </tr>
                </table>
                <button
                  type="button"
                  id="valider"
                  class="btn btn-white border-primary text-primary fw-bold border-3 custom-height-btn"
                  onclick="validStep(2)"
                >
                  valider
                </button>
              </div>
            </div>

            <!-- form autre-->
            <div class="col col-12 text-center">
              <div
                class="container-fluid bg-white p-3 rounded-4 form-container align-items-center align-self-center tab custom-height-tab text-primary"
              >
                <input
                  type="text"
                  class="border border-white input-table text-primary"
                  id="autre"
                  placeholder="Autre"
                />
                <button
                  type="button"
                  id="valider"
                  class="btn btn-white border-primary text-primary fw-bold border-3 custom-height-btn"
                  onclick="validStep(3)"
                >
                  valider
                </button>
              </div>
            </div>

            <!-- form gnr-->
            <div class="col col-12 text-center">
              <div
                class="container-fluid bg-white p-3 rounded-4 form-container align-items-center align-self-center tab custom-height-tab text-primary"
              >
                GNR fourni par le client :
                <div
                  class="btn-group"
                  role="group"
                  aria-label="Basic radio toggle button group"
                  id="GNR"
                >
                  <input
                    type="radio"
                    class="btn-check"
                    name="Oui"
                    id="Oui"
                    autocomplete="off"
                  />
                  <label class="btn btn-outline-primary" for="Oui">OUI</label>

                  <input
                    type="radio"
                    class="btn-check"
                    name="Oui"
                    id="Non"
                    autocomplete="off"
                  />
                  <label class="btn btn-outline-primary" for="Non">NON</label>
                  <div class="input-group">
                    <span
                      class="input-group-text custom-font-input bg-primary border border-primary text-white"
                      style="margin-left: 1vh; height: 3vh"
                      id="addon-wrapping"
                      >Quantité :</span
                    >
                    <input
                      type="text"
                      class="form-control border border-primary-subtle"
                      placeholder=""
                      aria-label="QuantiteGNR"
                      aria-describedby="addon-wrapping"
                      id="QuantiteGNR"
                    />
                  </div>
                </div>

                <br />
                <br />
                <button
                  type="button"
                  id="valider"
                  class="btn btn-white border-primary text-primary fw-bold border-3 custom-height-btn"
                  onclick="validStep(4)"
                >
                  valider
                </button>
              </div>
            </div>

            <!-- form Pièces Jointes-->
            <div class="col col-12 text-center">
              <div
                class="container-fluid bg-white p-3 rounded-4 form-container align-items-center align-self-center tab custom-height-tab text-primary"
              >
                Pour ajouter les pièces jointes nécesaires
                <br />
                <div class="input-group mb-3">
                  <input
                    id="selectFiles"
                    type="file"
                    class="form-control"
                    id="inputFiles"
                    multiple
                  />
                  <label class="input-group-text" for="inputFiles"
                    >Upload</label
                  >
                </div>
                <br />
                <div class="form-check">
                  <input
                    type="checkbox"
                    id="checkboxCertif"
                    class="form-check-input border border-primary mx-1"
                    value="test"
                    required
                  />
                  <label class="form-check-label" for="checkboxCertif"
                    >Je certifie l’exactitude des informations entrées dans
                    le/les fichiers ci joints</label
                  >
                </div>
                <br />
                <br />

                <button
                  type="button"
                  id="validateFiles"
                  class="btn btn-white border-primary text-primary fw-bold border-3 custom-height-btn"
                  onclick="validStep(5)"
                >
                  valider
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"
    ></script>
    <script src="script-att.js"></script>
    <script>
      $(document).ready(function () {
        $("#datesForage, #datesMinage").daterangepicker(
          {
            locale: {
              format: "DD-MM-YYYY",
              separator: " au ",
              applyLabel: "Appliquer",
              cancelLabel: "Annuler",
              fromLabel: "Du",
              toLabel: "À",
              customRangeLabel: "Personnalisé",
              weekLabel: "S",
              daysOfWeek: ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"],
              monthNames: [
                "Janvier",
                "Février",
                "Mars",
                "Avril",
                "Mai",
                "Juin",
                "Juillet",
                "Août",
                "Septembre",
                "Octobre",
                "Novembre",
                "Décembre",
              ],
              firstDay: 1,
            },
            opens: "right",
            autoUpdateInput: false,
          },
          function (start, end, label) {
            if (start.format("DD-MM-YYYY") === end.format("DD-MM-YYYY")) {
              this.element.val(start.format("DD-MM-YYYY"));
            } else {
              this.element.val(
                start.format("DD-MM-YYYY") + " au " + end.format("DD-MM-YYYY")
              );
            }
          }
        );
      });
    </script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
        set,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
      import {
        getStorage,
        ref as storageRef,
        uploadBytes,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA5KivS1hhrIufEYwt8T8MN1hguKa3aSMY",
        authDomain: "test-techmine.firebaseapp.com",
        databaseURL:
          "https://test-techmine-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "test-techmine",
        storageBucket: "test-techmine.appspot.com",
        messagingSenderId: "876142620682",
        appId: "1:876142620682:web:5bad29bd4f71d82be6aff3",
        measurementId: "G-2LKJFXNQ58",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase();
      const storage = getStorage();
      const auth = getAuth(app);

      let selectedClientId = null;
      let submitBtn = document.getElementById("submit");
      let selectedFiles = [];
      let validateFiles = document.getElementById("submit");
      let newNumber;

      // vérification de la version de l'application
      const versionRef = ref(db, "appInfo/version");
      onValue(versionRef, (snapshot) => {
        const latestVersion = snapshot.val();
        const currentVersion = localStorage.getItem("appVersion");
        if (currentVersion != latestVersion) {
          localStorage.setItem("appVersion", latestVersion);
          window.location.reload();
        }
      });

      // vérification de l'authentification de l'utilisateur
      function checkUserRole(userId) {
        const userRef = ref(db, `users/${userId}`);
        return get(userRef).then((snapshot) => {
          const userData = snapshot.val();
          console.log("Données utilisateur :", userData.nom);
          return (
            userData.role === "cadre" ||
            userData.role === "responsable exploitation" ||
            userData.role === "directeur" ||
            userData.role === "responsable agence"
          );
        });
      }

      // vérification de l'authentification de l'utilisateur
      function checkUserAuthentication() {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log(user);
          } else {
            console.log("pas d'utilisateur");
            window.location.href = "index.html";
          }
          if (sessionStorage.getItem("user-uid") == null) {
            window.location.href = "index.html";
          }
        });
      }

      // vérification du rôle de l'utilisateur
      auth.onAuthStateChanged((user) => {
        if (user) {
          checkUserRole(user.uid)
            .then((isCadre) => {
              const adminMenuItems =
                document.querySelectorAll(".menu-item-admin");
              adminMenuItems.forEach((item) => {
                item.style.display = isCadre ? "block" : "none";
              });
            })
            .catch((error) => {
              console.error("Erreur lors de la vérification du rôle :", error);
              const adminMenuItems =
                document.querySelectorAll(".menu-item-admin");
              adminMenuItems.forEach((item) => {
                item.style.display = "none";
              });
            });
        } else {
          const adminMenuItems = document.querySelectorAll(".menu-item-admin");
          adminMenuItems.forEach((item) => {
            item.style.display = "none";
          });
        }
      });

      // vérification de l'authentification de l'utilisateur
      async function getLastAttachementNumber() {
        const snapshot = await get(ref(db, "Attachement"));
        if (!snapshot.exists()) {
          return 9999;
        }
        const attachements = snapshot.val();
        const numbers = Object.keys(attachements).map((key) => parseInt(key));

        return Math.max(...numbers);
      }

      // Ajout des données dans la base de données
      async function AddData() {
        if (!allStepsValid()) {
          showMessageError(
            "Veuillez valider toutes les étapes avant de soumettre.",
            "warning"
          );
          return;
        }

        let client = document.getElementById("client").value || "";
        let chantier = document.getElementById("chantier").value || "";
        let observation = document.getElementById("obsevation").value || "";
        let forage = document.getElementById("forage").checked ? "oui" : "non";
        let HMFDebut = document.getElementById("HMFDebut").value || "";
        let NPlanForage = document.getElementById("NPlanForage").value || "";
        let HMFFin = document.getElementById("HMFFin").value || "";
        let HeuresPanne = document.getElementById("HeuresPanne").value || "";
        let HeuresArret = document.getElementById("HeuresArret").value || "";
        let DiametreForage =
          getElementsValuesFromNodeList(
            document.querySelectorAll("#DiametreForage")
          ) || "";
        let QuantiteForage =
          getElementsValuesFromNodeList(
            document.querySelectorAll("#QuantiteForage")
          ) || "";
        let UniteForage =
          getElementsValuesFromNodeList(
            document.querySelectorAll("#UniteForage")
          ) || "";
        let minage = document.getElementById("minage").checked ? "oui" : "non";
        let NPlanTir = document.getElementById("NPlanTir").value || "";
        let NbSismographes =
          document.getElementById("NbSismographes").value || "";
        let QuantiteMinage =
          document.getElementById("QuantiteMinage").value || "";
        let UniteMinage = document.getElementById("UniteMinage").value || "";
        let autre = document.getElementById("autre").value || "";
        let datesForage = document.getElementById("datesForage").value || "";
        let datesMinage = document.getElementById("datesMinage").value || "";
        let GNR = document.getElementById("Oui").checked
          ? "Oui"
          : document.getElementById("Non").checked
          ? "Non"
          : "";
        let implantation = getImplantationValue();
        let Transfert = document.getElementById("Transfert").value || "";
        let CommP = document.getElementById("CommP").value || "";
        let CommA = document.getElementById("CommA").value || "";
        let QuantiteGNR = document.getElementById("QuantiteGNR").value || "";
        let perteOutillageTir = document.getElementById("oui_perte").checked
          ? "oui"
          : document.getElementById("non_perte").checked
          ? "non"
          : "";

        const lastNumber = await getLastAttachementNumber();
        const newNumber = lastNumber + 1;

        const date = new Date().toLocaleDateString("fr-FR");
        let user = sessionStorage.getItem("user-uid");

        set(ref(db, "Attachement/" + newNumber), {
          infos: {
            client: client,
            chantier: chantier,
            observation: observation,
            forage: forage,
            HMFDebut: HMFDebut,
            NPlanForage: NPlanForage,
            HMFFin: HMFFin,
            HeuresPanne: HeuresPanne,
            HeuresArret: HeuresArret,
            DiametreForage: DiametreForage,
            QuantiteForage: QuantiteForage,
            UniteForage: UniteForage,
            minage: minage,
            NPlanTir: NPlanTir,
            NbSismographes: NbSismographes,
            QuantiteMinage: QuantiteMinage,
            UniteMinage: UniteMinage,
            autre: autre,
            GNR: GNR,
            datesForage: datesForage,
            datesMinage: datesMinage,
            implantation: implantation,
            Transfert: Transfert,
            CommP: CommP,
            CommA: CommA,
            QuantiteGNR: QuantiteGNR,
            perteOutillageTir: perteOutillageTir,
          },
          date: date,
          user: user,
          dateTimestamp: new Date().getTime(),
        })
          .then(() => {
            showMessage(
              "Données sauvegardées avec succès !",
              "success",
              newNumber
            );
          })
          .catch((error) => {
            showMessage(
              "Erreur lors de la sauvegarde des données : " + error.message,
              "danger"
            );
          });
      }

      // fonction pour afficher les messages d'alerte
      function showMessage(message, type, newNumber) {
        const messageContainer = document.getElementById("alert-container");
        messageContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                  ${message}
                                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>`;
        setTimeout(() => {
          const alert = bootstrap.Alert.getInstance(
            document.querySelector(".alert")
          );
          alert.close();
        }, 5000);

        setTimeout(() => {
          const newUrl = "Impression-attachement.html?number=" + newNumber;
          window.location.href = newUrl;
        }, 3000);
      }

      // fonction pour afficher les messages d'alerte d'erreur
      function showMessageError(message, type, newNumber) {
        const messageContainer = document.getElementById("alert-container");
        messageContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                  ${message}
                                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>`;
      }

      // fonction pour récupérer la valeur de implantation
      function getImplantationValue() {
        let radios = document
          .getElementById("Implantation")
          .getElementsByTagName("input");
        for (let i = 0; i < radios.length; i++) {
          if (radios[i].checked) {
            return radios[i].id;
          }
        }
        return "";
      }
      let clientsData = {};
      let carrieresData = {};

      // récupération des données clients et carrieres
      function fetchClientsAndCarrieres() {
        const clientsRef = ref(db, "clients");
        const carrieresRef = ref(db, "chantiers");

        get(clientsRef).then((clientsSnapshot) => {
          clientsData = clientsSnapshot.val() || {};
          populateClientsDataList();
        });

        get(carrieresRef).then((carrieresSnapshot) => {
          carrieresData = carrieresSnapshot.val() || {};
          populateCarrieresDataList();
        });
      }

      // ajout d'une ligne de client dans le tableau
      function populateClientsDataList() {
        const clientDataList = document.getElementById("clients");
        clientDataList.innerHTML = "";

        const sortedClientIds = Object.keys(clientsData).sort((a, b) =>
          clientsData[a].name.localeCompare(clientsData[b].name)
        );

        for (const clientId of sortedClientIds) {
          const clientName = clientsData[clientId].name;
          const option = document.createElement("option");
          option.value = clientName;
          option.dataset.clientId = clientId;
          clientDataList.appendChild(option);
        }
      }

      // ajout d'une ligne de carrieres dans le tableau
      function populateCarrieresDataList() {
        const carriereDataList = document.getElementById("chantiers");
        carriereDataList.innerHTML = "";

        const sortedCarriereIds = Object.keys(carrieresData).sort((a, b) =>
          carrieresData[a].name.localeCompare(carrieresData[b].name)
        );

        for (const carriereId of sortedCarriereIds) {
          const carriereName = carrieresData[carriereId].name;
          const option = document.createElement("option");
          option.value = carriereName;
          option.dataset.carriereId = carriereId;
          carriereDataList.appendChild(option);
        }
      }

      // Filtrage des carrieres par client
      document.getElementById("client").addEventListener("input", () => {
        const selectedClientName = document.getElementById("client").value;
        const selectedClient = Object.values(clientsData).find(
          (clients) => clients.name === selectedClientName
        );

        if (selectedClient) {
          selectedClientId = selectedClient.id;
          filterCarrieresByClient(selectedClientId);
        }
      });

      // Filtrage des carrieres par client
      function filterCarrieresByClient(clientId) {
        const carriereDataList = document.getElementById("chantiers");
        carriereDataList.innerHTML = "";

        const filteredCarrieres = Object.values(carrieresData).filter(
          (carriere) => carriere.clientId === clientId
        );

        const sortedCarriereIds = filteredCarrieres.sort((a, b) =>
          a.name.localeCompare(b.name)
        );

        for (const carriere of sortedCarriereIds) {
          const option = document.createElement("option");
          option.value = carriere.name;
          option.dataset.carriereId = carriere.id;
          carriereDataList.appendChild(option);
        }
      }

      // remplissage du client avec la carriere selectionnée
      document.getElementById("chantier").addEventListener("input", () => {
        const selectedCarriereName = document.getElementById("chantier").value;
        const selectedCarriere = Object.values(carrieresData).find(
          (carriere) => carriere.name === selectedCarriereName
        );

        if (selectedCarriere) {
          const clientName = clientsData[selectedCarriere.clientId].name;
          document.getElementById("client").value = clientName;
        }
      });

      // recuperation des documents sélectionnés
      document.getElementById("selectFiles").addEventListener("change", (e) => {
        selectedFiles = e.target.files;
      });

      //envoi des documents sélectionnés dans le storage
      validateFiles.addEventListener("click", async () => {
        AddData();
        const lastNumber = await getLastAttachementNumber();
        newNumber = lastNumber + 1;
        for (let i = 0; i < selectedFiles.length; i++) {
          try {
            const file = selectedFiles[i];
            const storageRef1 = storageRef(
              storage,
              `attachments/${newNumber}/${file.name}`
            );
            uploadBytes(storageRef1, file).then((snapshot) => {
              console.log("Uploaded a file:", file.name);
            });
          } catch (error) {
            console.log(error);
          }
        }
      });

      window.onload = function () {
        fetchClientsAndCarrieres();
        checkUserAuthentication();
      };
    </script>
  </body>
</html>
