<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="style-top.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container-fluid align-items-center custom-height-top">
      <div
        class="row bg-gradient bg-white p-4 align-items-center custom-height-top"
      >
        <div class="col col-2 text-start">
          <img
            src="logo techmine.svg"
            alt="bouton de menu"
            class="custom-height-logo"
          />
        </div>
        <div class="col col-8 text-center">
          <h1 class="custom-font-top ms-5">Liste des Signalements</h1>
        </div>
        <div class="col col-2 text-end h-20">
          <div class="dropdown text-center">
            <button
              class="btn dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <img
                src="symbole-de-menu-pour-android.png"
                alt="bouton de menu"
                class="custom-height-menu"
              />
            </button>
            <ul
              class="dropdown-menu dropdown-menu-dark custom-menu text-center"
            >
              <li>
                <a class="dropdown-item" href="accueil.html"
                  >Retourner à l'accueil</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item" href="rapport.html">Rapports</a></li>
              <li>
                <a class="dropdown-item" href="liste-rapport.html"
                  >Liste des Rapports</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item" href="attachement.html"
                  >Attachements</a
                >
              </li>
              <li>
                <a class="dropdown-item" href="liste-attachement.html"
                  >Liste des attachements</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item" href="signalement.html">Signalement</a>
              </li>
              <li>
                <a class="dropdown-item" href="liste-intervention.html"
                  >Liste des Signalements</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item" href="machines.html"
                  >Gestion des Machines</a
                >
              </li>
              <li><hr class="dropdown-divider menu-item-admin" /></li>
              <li><hr class="dropdown-divider menu-item-admin" /></li>
              <li class="menu-item-admin">
                <div class="dropdown-header" style="font-size: 2rem">
                  Administrateur
                </div>
              </li>
              <li class="menu-item-admin">
                <a class="dropdown-item" href="ajout-utilisateur.html"
                  >Gestion des Utilisateurs</a
                >
              </li>
              <li class="menu-item-admin">
                <a class="dropdown-item" href="ajout-client.html"
                  >Gestion des Clients</a
                >
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid custom-height-bot">
      <div class="row bg-primary justify-content-center align-items-center">
        <button
          type="button"
          class="btn btn-light custom-btn-liste"
          style="width: 45vh"
          data-bs-toggle="modal"
          data-bs-target="#filterModal"
        >
          Filtrer par machine
        </button>
        <button
          type="button"
          class="btn btn-success custom-btn-liste"
          style="width: 45vh"
          id="exportCsvButton"
        >
          Exporter en CSV
        </button>
      </div>
      <div class="row bg-primary" style="min-height: 80vh">
        <div class="col col-1"></div>
        <div class="col col-10 mt-5 d-flex flex-column">
          <!-- bloc de formulaire blanc -->
          <div id="liste"></div>
        </div>
      </div>
    </div>

    <!-- Modal pour le choix de machine -->
    <div
      class="modal fade"
      id="filterModal"
      tabindex="-1"
      aria-labelledby="filterModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="filterModalLabel">
              Choisir une Machine
            </h5>

            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="filterForm">
              <div class="mb-3">
                <label for="machineSelect" class="form-label">Machine</label>
                <select
                  class="form-select"
                  id="machineSelect"
                  required
                ></select>
              </div>
              <button type="submit" class="btn btn-primary">Filtrer</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal pour modifier un signalement -->
    <div
      class="modal fade"
      id="modifyModal"
      tabindex="-1"
      aria-labelledby="modifyModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modifyModalLabel">
              Modifier Signalement
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="modifyForm">
              <div class="mb-3">
                <label for="machineSelect2" class="form-label">Machine</label>
                <select
                  class="form-select"
                  id="machineSelect2"
                  required
                ></select>
              </div>
              <div class="mb-3">
                <label for="observationInput" class="form-label"
                  >Observation</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="observationInput"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="commentaire" class="form-label">commentaire:</label>
                <textarea
                  class="form-control"
                  id="commentaire"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="prioritySelect" class="form-label">Priorité</label>
                <select class="form-select" id="prioritySelect" required>
                  <option value="1">
                    Intervention à prévoir à la prochaine vidange
                  </option>
                  <option value="2">
                    Intervention à prévoir sous 15 jours
                  </option>
                  <option value="3">
                    Intervention à prévoir sous 10 jours
                  </option>
                  <option value="4">
                    Intervention à prévoir rapidement (Arrêt)
                  </option>
                </select>
              </div>
              <button type="button" class="btn btn-danger" id="deleteButton">
                Supprimer
              </button>
              <button type="submit" class="btn btn-primary">Enregistrer</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        get,
        onValue,
        query,
        orderByChild,
        equalTo,
        update,
        remove,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA5KivS1hhrIufEYwt8T8MN1hguKa3aSMY",
        authDomain: "test-techmine.firebaseapp.com",
        databaseURL:
          "https://test-techmine-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "test-techmine",
        storageBucket: "test-techmine.appspot.com",
        messagingSenderId: "876142620682",
        appId: "1:876142620682:web:5bad29bd4f71d82be6aff3",
        measurementId: "G-2LKJFXNQ58",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase();
      const auth = getAuth();

      let currentSignalementKey = "";
      let selectedMachine = null;
      let filteredSignalements = [];

      // vérification de la version de l'application
      const versionRef = ref(db, "appInfo/version");
      onValue(versionRef, (snapshot) => {
        const latestVersion = snapshot.val();
        const currentVersion = localStorage.getItem("appVersion");
        if (currentVersion != latestVersion) {
          localStorage.setItem("appVersion", latestVersion);
          window.location.reload();
        }
      });

      // Fonction pour vérifier le rôle de l'utilisateur
      function checkUserRole(userId) {
        const userRef = ref(db, `users/${userId}`);
        return get(userRef).then((snapshot) => {
          const userData = snapshot.val();
          console.log("Données utilisateur :", userData.role);
          return (
            userData.role === "cadre" ||
            userData.role === "responsable exploitation" ||
            userData.role === "directeur" ||
            userData.role === "responsable agence"
          );
        });
      }
      // Fonction pour récupérer les machines
      function fetchMachines() {
        const machinesRef = ref(db, "machine/");
        get(machinesRef).then((snapshot) => {
          const data = snapshot.val();
          const machineSelect = document.getElementById("machineSelect");
          machineSelect.innerHTML =
            '<option value="">Sélectionnez une machine</option>';
          for (const key in data) {
            if (data.hasOwnProperty(key)) {
              const machine = data[key];
              const option = document.createElement("option");
              option.value = key;
              option.textContent = machine.Nmatériel;
              machineSelect.appendChild(option);
            }
          }
          const machineSelect2 = document.getElementById("machineSelect2");
          machineSelect2.innerHTML =
            '<option value="">Sélectionnez une machine</option>';
          for (const key in data) {
            if (data.hasOwnProperty(key)) {
              const machine = data[key];
              const option = document.createElement("option");
              option.value = key;
              option.textContent = machine.Nmatériel;
              machineSelect2.appendChild(option);
            }
          }
        });
      }

      // Fonction pour récupérer les signalements
      function fetchSignalements(machineId = null) {
        const signalementsRef = ref(db, "signalement/");
        onValue(signalementsRef, (snapshot) => {
          try {
            const data = snapshot.val();
            let signalementsArray = [];

            for (const key in data) {
              if (data.hasOwnProperty(key)) {
                signalementsArray.push({ key, ...data[key] });
              }
            }

            if (machineId) {
              signalementsArray = signalementsArray.filter(
                (signalement) => signalement.machine === machineId
              );
            }

            signalementsArray.sort((a, b) => b.priorite - a.priorite);
            filteredSignalements = signalementsArray;

            const liste = document.getElementById("liste");
            liste.innerHTML = "";

            signalementsArray.forEach((signalement) => {
              const machineRef = ref(db, "machine/" + signalement.machine);

              get(machineRef).then((machineSnapshot) => {
                const machineData = machineSnapshot.val();
                console.log(machineSnapshot.val());
                const machineName = machineData
                  ? machineData.Nmatériel
                  : "Inconnu";

                const operatorRef = ref(db, "users/" + signalement.operator);
                get(operatorRef).then((operatorSnapshot) => {
                  const operatorData = operatorSnapshot.val();
                  const operatorName = operatorData
                    ? `${operatorData.nom} ${operatorData.prenom}`
                    : "Inconnu";

                  const signalementDiv = document.createElement("div");
                  signalementDiv.className =
                    "container-fluid bg-white p-3 rounded-4 form-contain my-4 custom-liste-inter position-relative";

                  const priorityCircle = document.createElement("div");
                  priorityCircle.className = `priority-circle priority-${signalement.priorite}`;

                  const priorityMap = {
                    0: "non renseignée",
                    1: "Intervention à prévoir à la prochaine vidange",
                    2: "Intervention à prévoir sous 15 jours",
                    3: "Intervention à prévoir sous 10 jours",
                    4: "Intervention à prévoir rapidement (Arrêt)",
                  };
                  signalement.priorite =
                    priorityMap[signalement.priorite] || "Inconnue";

                  if (signalement.commentaire == "") {
                    signalement.commentaire = "aucun";
                  }

                  const modifyButton = document.createElement("button");
                  modifyButton.className =
                    "btn btn-danger modify-button custom-font-liste";
                  modifyButton.textContent = "Modifier";
                  modifyButton.setAttribute("data-key", signalement.key);
                  modifyButton.addEventListener("click", () => {
                    currentSignalementKey = signalement.key;
                    document.getElementById("observationInput").value =
                      signalement.observations;
                    document.getElementById("prioritySelect").value =
                      signalement.priorite;
                    const modifyModal = new bootstrap.Modal(
                      document.getElementById("modifyModal")
                    );
                    modifyModal.show();
                  });
                  console.log(machineName);

                  signalementDiv.innerHTML = `
                    Machine: <strong>${machineName}</strong>
                    <br>
                    Date de signalement: <strong>${signalement.date}</strong>
                    <br>
                    Opérateur: <strong>${operatorName}</strong>
                    <br>
                    Signalement: <strong>${signalement.observations}</strong>
                    <br>
                    Priorité: <strong>${signalement.priorite}</strong>
                    <br>
                    Commentaire: <strong>${signalement.commentaire}</strong>
                  `;

                  signalementDiv.appendChild(priorityCircle);
                  signalementDiv.appendChild(modifyButton);
                  liste.appendChild(signalementDiv);
                });
              });
            });
          } catch (error) {
            console.error(error);
          }
        });
      }

      // Exporter les signalements en CSV
      document
        .getElementById("exportCsvButton")
        .addEventListener("click", exportToCSV);

      function exportToCSV() {
        const csvRows = [];
        const headers = [
          "Date",
          "Machine",
          "Observation",
          "Opérateur",
          "Priorité",
          "Commentaire",
        ];
        csvRows.push(headers.join(";"));

        const rowsPromises = filteredSignalements.map((signalement) => {
          if (!signalement.machine || !signalement.operator) {
            console.error(
              "Signalement missing machine or operator:",
              signalement
            );
            return Promise.resolve();
          }

          const machineRef = ref(db, "machine/" + signalement.machine);
          const operatorRef = ref(db, "users/" + signalement.operator);

          return Promise.all([get(machineRef), get(operatorRef)])
            .then(([machineSnapshot, operatorSnapshot]) => {
              const machineData = machineSnapshot.val();
              const operatorData = operatorSnapshot.val();
              const machineName = machineData
                ? machineData.Nmatériel
                : "Inconnu";
              const operatorName = operatorData
                ? `${operatorData.nom} ${operatorData.prenom}`
                : "Inconnu";

              const row = [
                signalement.date || "Inconnu",
                machineName,
                signalement.observations || "Non renseignée",
                operatorName,
                signalement.priorite || "Non renseignée",
                signalement.commentaire || "Non renseigné",
              ]
                .map((e) => `"${e.replace(/"/g, '""')}"`)
                .join(";");
              csvRows.push(row);
            })
            .catch((error) => {
              console.error("Error fetching data:", error);
            });
        });

        Promise.all(rowsPromises)
          .then(() => {
            const csvData = csvRows.join("\n");
            const finalcsv = "\uFEFF" + csvData;
            const blob = new Blob([finalcsv], {
              type: "text/csv;charset=utf-8",
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "signalements.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          })
          .catch((error) => {
            console.error("Error generating CSV:", error);
          });
      }

      // Fonction pour supprimer un signalement
      function deleteSignalement(key) {
        if (confirm("Êtes-vous sûr de vouloir supprimer ce signalement ?")) {
          remove(ref(db, "signalement/" + key))
            .then(() => {
              location.reload();
            })
            .catch((error) => {
              console.error(error);
            });
        }
      }

      // Enregistrement des modifications
      document
        .getElementById("modifyForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const newObservation =
            document.getElementById("observationInput").value;
          const newPriority = document.getElementById("prioritySelect").value;
          const commentaire = document.getElementById("commentaire").value;
          const newMachine = document.getElementById("machineSelect2").value;

          update(ref(db, "signalement/" + currentSignalementKey), {
            observations: newObservation,
            priorite: newPriority,
            commentaire: commentaire,
            machine: newMachine,
          })
            .then(() => {
              const modifyModal = bootstrap.Modal.getInstance(
                document.getElementById("modifyModal")
              );
              modifyModal.hide();
              location.reload();
            })
            .catch((error) => {
              console.error(error);
            });
        });
      // Suppression d'un signalement
      document
        .getElementById("deleteButton")
        .addEventListener("click", function () {
          const confirmation = confirm(
            "Êtes-vous sûr de vouloir supprimer ce signalement ?"
          );
          if (confirmation) {
            remove(ref(db, "signalement/" + currentSignalementKey), null)
              .then(() => {
                const modifyModal = bootstrap.Modal.getInstance(
                  document.getElementById("modifyModal")
                );
                modifyModal.hide();
                location.reload();
              })
              .catch((error) => {
                console.error(error);
              });
          }
        });

      // Filtrage des signalements
      document.getElementById("filterForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const machineSelect = document.getElementById("machineSelect");
        selectedMachine = machineSelect.value;
        fetchSignalements(selectedMachine);
        const filterModal = bootstrap.Modal.getInstance(
          document.getElementById("filterModal")
        );
        filterModal.hide();
      });

      // Vérification du rôle de l'utilisateur connecté
      auth.onAuthStateChanged((user) => {
        if (user) {
          checkUserRole(user.uid)
            .then((isCadre) => {
              const adminMenuItems =
                document.querySelectorAll(".menu-item-admin");
              adminMenuItems.forEach((item) => {
                item.style.display = isCadre ? "block" : "none";
              });
            })
            .catch((error) => {
              console.error("Erreur lors de la vérification du rôle :", error);
              const adminMenuItems =
                document.querySelectorAll(".menu-item-admin");
              adminMenuItems.forEach((item) => {
                item.style.display = "none";
              });
            });
        } else {
          const adminMenuItems = document.querySelectorAll(".menu-item-admin");
          adminMenuItems.forEach((item) => {
            item.style.display = "none";
          });
        }
      });

      fetchMachines();
      fetchSignalements();
    </script>
  </body>
</html>
